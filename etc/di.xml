<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <preference for="Hokodo\BnplCommerce\Api\Data\CompanyInterface" type="Hokodo\BnplCommerce\Model\Data\Company" />
    <preference for="Hokodo\BnplCommerce\Api\CompanyRepositoryInterface" type="Hokodo\BnplCommerce\Model\CompanyRepository" />
    <type name="Magento\Company\Model\Company\DataProvider">
        <plugin name="add_hokodo_data" type="Hokodo\BnplCommerce\Plugin\Company\Model\DataProvider"/>
    </type>

    <!-- Company Search -->
    <preference for="Hokodo\BnplCommerce\Api\Data\Gateway\CompanySearchRequestInterface" type="\Hokodo\BnplCommerce\Model\Data\Gateway\CompanySearchRequest" />

    <virtualType name="Hokodo\BNPL\Gateway\Command\CommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="hokodo_company_search" xsi:type="string">Hokodo\BnplCommerce\Gateway\Command\CompanySearch</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Command\CompanySearch" type="Hokodo\BNPL\Gateway\Command\HokodoGatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Hokodo\BnplCommerce\Gateway\Request\CompanySearch\BuilderComposite</argument>
            <argument name="resultFactory" xsi:type="object">Hokodo\BnplCommerce\Gateway\Command\CompanySearch\ResultInterfaceFactory</argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanySearch\BuilderComposite" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="api_key" xsi:type="string">Hokodo\BNPL\Gateway\Request\AuthorizationBuilder</item>
                <item name="uri" xsi:type="string">Hokodo\BnplCommerce\Gateway\Request\CompanySearch</item>
                <item name="method" xsi:type="string">Hokodo\BNPL\Gateway\Request\PostMethodBuilder</item>
                <item name="body" xsi:type="string">Hokodo\BnplCommerce\Gateway\Request\CompanySearchEventBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanySearchEventBuilder" type="Hokodo\BNPL\Gateway\Request\Sdk\GeneralSubjectBuilder">
        <arguments>
            <argument name="endpointBuilder" xsi:type="object">Hokodo\BnplCommerce\Gateway\Request\CompanySearch</argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanySearch" type="Hokodo\BNPL\Gateway\Request\Sdk\EndpointBuilder">
        <arguments>
            <argument name="endpoint" xsi:type="string">companies/search</argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Command\CompanySearch\ResultInterfaceFactory" type="Magento\Payment\Gateway\Command\ResultInterfaceFactory">
        <arguments>
            <argument name="instanceName" xsi:type="string">\Hokodo\BNPL\Gateway\Command\Result\Company</argument>
        </arguments>
    </virtualType>
    <!-- /Company Search -->

    <!-- Company auto match feature -->
    <type name="Magento\Company\Model\ResourceModel\Company">
        <plugin name="hokodo_match_company" type="Hokodo\BnplCommerce\Plugin\Company\ResourceModel\Company" />
    </type>
    <!-- /Company auto match feature -->
    <preference for="Hokodo\BNPL\Api\HokodoEntityTypeResolverInterface" type="Hokodo\BnplCommerce\Model\HokodoEntityTypeResolver"/>
    <type name="Hokodo\BNPL\Model\HokodoCompanyProvider">
        <arguments>
            <argument name="companyProviderTypes" xsi:type="array">
                <item name="company" xsi:type="object">Hokodo\BnplCommerce\Api\CompanyRepositoryInterface</item>
            </argument>
        </arguments>
    </type>

    <!-- Company Credit Limit -->
    <preference for="Hokodo\BnplCommerce\Api\Data\Gateway\CompanyCreditRequestInterface" type="Hokodo\BnplCommerce\Model\Data\Gateway\CompanyCreditRequest" />
    <preference for="Hokodo\BnplCommerce\Api\Data\Company\CreditInterface" type="Hokodo\BnplCommerce\Model\Data\Company\Credit" />
    <preference for="Hokodo\BnplCommerce\Api\Data\Company\CreditLimitInterface" type="Hokodo\BnplCommerce\Model\Data\Company\CreditLimit" />
    <preference for="Hokodo\BnplCommerce\Api\CompanyCreditServiceInterface" type="Hokodo\BnplCommerce\Model\CompanyCreditService" />

    <virtualType name="Hokodo\BNPL\Gateway\Command\CommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="hokodo_company_credit" xsi:type="string">Hokodo\BnplCommerce\Gateway\Command\CompanyCredit</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Command\CompanyCredit" type="Hokodo\BNPL\Gateway\Command\HokodoGatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Hokodo\BnplCommerce\Gateway\Request\CompanyCredit\BuilderComposite</argument>
            <argument name="resultFactory" xsi:type="object">Hokodo\BnplCommerce\Gateway\Command\CompanyCredit\ResultInterfaceFactory</argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanyCredit\BuilderComposite" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="api_key" xsi:type="string">Hokodo\BNPL\Gateway\Request\AuthorizationBuilder</item>
                <item name="uri" xsi:type="string">Hokodo\BnplCommerce\Gateway\Request\CompanyCredit</item>
                <item name="method" xsi:type="string">Hokodo\BNPL\Gateway\Request\PostMethodBuilder</item>
                <item name="body" xsi:type="string">Hokodo\BnplCommerce\Gateway\Request\CompanyCreditEventBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanyCreditEventBuilder" type="Hokodo\BNPL\Gateway\Request\Sdk\GeneralSubjectBuilder">
        <arguments>
            <argument name="endpointBuilder" xsi:type="object">Hokodo\BnplCommerce\Gateway\Request\CompanyCredit</argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Request\CompanyCredit" type="Hokodo\BNPL\Gateway\Request\Sdk\EndpointBuilder">
        <arguments>
            <argument name="endpoint" xsi:type="string">payment/credit_limits/company/:company_id</argument>
            <argument name="params" xsi:type="array">
                <item name=":company_id" xsi:type="string">company_id</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="Hokodo\BnplCommerce\Gateway\Command\CompanyCredit\ResultInterfaceFactory" type="Magento\Payment\Gateway\Command\ResultInterfaceFactory">
        <arguments>
            <argument name="instanceName" xsi:type="string">\Hokodo\BnplCommerce\Gateway\Command\Result\CompanyCredit</argument>
        </arguments>
    </virtualType>

    <!-- Logger section start -->
    <type name="Hokodo\BnplCommerce\Controller\Adminhtml\Company\SaveCompanyId">
        <arguments>
            <argument name="logger" xsi:type="object">HokodoLogger</argument>
        </arguments>
    </type>
    <type name="Hokodo\BnplCommerce\Model\CompanyRepository">
        <arguments>
            <argument name="logger" xsi:type="object">HokodoLogger</argument>
        </arguments>
    </type>
    <type name="Hokodo\BnplCommerce\Plugin\Company\ResourceModel\Company">
        <arguments>
            <argument name="logger" xsi:type="object">HokodoLogger</argument>
        </arguments>
    </type>
    <!-- Logger section end -->
    <type name="Hokodo\BNPL\Gateway\Command\PostSale\CapturePayment">
        <plugin name="update_company_credit_limit_after_capture"
                type="Hokodo\BnplCommerce\Plugin\PostSale\UpdateCompanyCreditLimit"/>
    </type>
    <type name="Hokodo\BNPL\Gateway\Command\PostSale\RefundPayment">
        <plugin name="update_company_credit_limit_after_refund"
                type="Hokodo\BnplCommerce\Plugin\PostSale\UpdateCompanyCreditLimit"/>
    </type>
    <type name="Hokodo\BNPL\Gateway\Command\PostSale\VoidPayment">
        <plugin name="update_company_credit_limit_after_void"
                type="Hokodo\BnplCommerce\Plugin\PostSale\UpdateCompanyCreditLimit"/>
    </type>
</config>
